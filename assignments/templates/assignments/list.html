{% extends "core/base.html" %}
{% load core_tags %}

{% block title %}–ü–æ—Ä—É—á–µ–Ω–∏—è{% endblock %}
{% block breadcrumb %}<span class="sep">‚Ä∫</span><span class="current">–ü–æ—Ä—É—á–µ–Ω–∏—è</span>{% endblock %}

{% block extra_css %}
.content { background: #f5f5f3; }

/* ‚ïê‚ïê –¢–£–õ–ë–ê–† ‚ïê‚ïê */
.toolbar {
    background: #fff;
    border: 1px solid #e8e8e4;
    margin-bottom: 16px;
    overflow: hidden;
}
.toolbar__top {
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    border-bottom: 1px solid #f0f0ee;
}
.toolbar__title {
    font-family: var(--font-h);
    font-size: 18px;
    font-weight: 700;
    color: #111;
}
.toolbar__count {
    font-size: 11px;
    color: #aaa;
    margin-left: 8px;
    font-family: var(--font-b);
    font-weight: 400;
}

/* ‚îÄ‚îÄ –ü–æ–∏—Å–∫ ‚îÄ‚îÄ */
.search-wrap { position: relative; flex:1; max-width:300px; min-width:160px; }
.search-wrap__icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); font-size:13px; color:#bbb; pointer-events:none; }
.search-input {
    width:100%; font-family:var(--font-b); font-size:13px;
    padding:7px 10px 7px 32px;
    border:1px solid #e8e8e4; background:#fafaf8; color:#111; outline:none;
    transition:border-color .15s, box-shadow .15s;
}
.search-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(79,142,247,.1); background:#fff; }

/* ‚îÄ‚îÄ –§–∏–ª—å—Ç—Ä—ã ‚îÄ‚îÄ */
.filters-wrap {
    background: #fafaf8;
    border-bottom: 1px solid #f0f0ee;
}
.filters-row {
    padding: 10px 20px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: flex-end;
}
.filters-row + .filters-row { padding-top: 0; }

.fg { display:flex; flex-direction:column; gap:3px; }
.fg label { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:#bbb; }

.f-select, .f-date {
    font-family:var(--font-b); font-size:12px;
    padding:6px 8px;
    border:1px solid #e8e8e4; background:#fff; color:#111;
    outline:none; cursor:pointer;
    transition:border-color .15s;
}
.f-select { min-width:140px; }
.f-date   { min-width:120px; }
.f-select:focus, .f-date:focus { border-color:var(--accent); }
.f-active { border-color:var(--accent) !important; background:#eef3ff !important; }

/* –ë—ã—Å—Ç—Ä—ã–µ –¥–∞—Ç—ã */
.quick-dates {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    flex-wrap: wrap;
}
.qd-label { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#bbb; display:block; margin-bottom:3px; }
.qbtn {
    font-family:var(--font-b); font-size:11px;
    padding:6px 10px;
    border:1px solid #e8e8e4; background:#fff; color:#555;
    cursor:pointer; white-space:nowrap;
    transition:all .12s;
}
.qbtn:hover { background:var(--dark); color:#fff; border-color:var(--dark); }
.qbtn--active { background:var(--dark); color:#fff; border-color:var(--dark); }

/* –ê–∫—Ç–∏–≤–Ω—ã–µ –±–µ–π–¥–∂–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.active-filters {
    padding: 8px 20px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
    border-top: 1px solid #f0f0ee;
    background: #fff;
}
.af-label { font-size:9.5px; color:#bbb; }
.af-badge {
    display:inline-flex; align-items:center; gap:5px;
    padding:3px 10px;
    background:var(--dark); color:#fff; font-size:11px;
    cursor:pointer; transition:background .12s;
}
.af-badge:hover { background:#333; }

/* ‚ïê‚ïê –ú–ê–°–°–û–í–´–ï –î–ï–ô–°–¢–í–ò–Ø ‚ïê‚ïê */
.bulk-bar {
    background:var(--dark); color:#fff;
    padding:10px 20px;
    display:none; align-items:center; gap:10px; flex-wrap:wrap;
    border-top:1px solid rgba(255,255,255,.1);
}
.bulk-bar.visible { display:flex; }
.bulk-info { font-size:12.5px; font-weight:700; }
.bulk-info span { color:var(--accent); }
.bulk-sep { width:1px; height:20px; background:rgba(255,255,255,.2); flex-shrink:0; }
.bbtn {
    padding:5px 13px; font-family:var(--font-b); font-size:11.5px; font-weight:700;
    cursor:pointer; border:1px solid rgba(255,255,255,.25); background:transparent; color:#fff;
    transition:background .12s; border-radius:2px; white-space:nowrap;
}
.bbtn:hover { background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.5); }
.bbtn--x { background:none; border:none; color:rgba(255,255,255,.4); font-size:18px; cursor:pointer; padding:0 4px; margin-left:auto; }
.bbtn--x:hover { color:#fff; }

/* ‚ïê‚ïê –¢–ê–ë–õ–ò–¶–ê ‚ïê‚ïê */
.table-wrap { background:#fff; border:1px solid #e8e8e4; overflow-x:auto; }
.at {
    width:100%; border-collapse:collapse; font-size:12.5px;
}
.at thead tr { background:var(--dark); }
.at th {
    padding:10px 12px; text-align:left; color:#fff;
    font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.1em;
    white-space:nowrap; user-select:none;
}
.at th.s { cursor:pointer; }
.at th.s:hover { background:rgba(255,255,255,.08); }
.sort-ic { opacity:.35; margin-left:3px; font-size:10px; }
.sort-ic.up { opacity:1; }
.sort-ic.dn { opacity:1; }

.at td { padding:11px 12px; border-bottom:1px solid #f0f0ee; vertical-align:middle; }
.at tbody tr { transition:background .1s; }
.at tbody tr:hover { background:#fafaf8; }
.at tbody tr.sel { background:#eef3ff; }
.at tbody tr:last-child td { border-bottom:none; }

.col-cb { width:40px; text-align:center; }
.col-cb input { cursor:pointer; width:15px; height:15px; accent-color:var(--dark); }

.doc-type { font-size:9.5px; color:#aaa; text-transform:uppercase; letter-spacing:.04em; margin-bottom:1px; }
.doc-num  { font-family:var(--font-h); font-weight:700; font-size:13px; white-space:nowrap; }
.doc-date { font-size:10px; color:#bbb; margin-top:2px; }

.cell-desc { max-width:280px; }
.desc-txt { font-size:12.5px; line-height:1.4; color:#222; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

.pname { font-weight:700; font-size:11.5px; white-space:nowrap; }
.pdept { font-size:10px; color:#aaa; margin-top:1px; white-space:nowrap; }

.dl-date { font-family:var(--font-h); font-weight:700; font-size:13px; white-space:nowrap; }
.dl-badge { display:inline-block; margin-top:3px; padding:1px 7px; font-size:9.5px; font-weight:700; white-space:nowrap; border-radius:1px; }
.db-ov { background:#fde8e8; color:#c0392b; }
.db-td { background:#fff3e0; color:#904000; }
.db-sn { background:#e8f5e9; color:#2e7d32; }
.db-ok { background:#f3f3f3; color:#888; }

.sbadge { display:inline-block; padding:3px 9px; font-size:9.5px; font-weight:700; letter-spacing:.04em; text-transform:uppercase; border-radius:1px; white-space:nowrap; }
.s-NEW         { background:#e3f2fd; color:#1565c0; }
.s-IN_PROGRESS { background:#e8f5e9; color:#2e7d32; }
.s-OVERDUE     { background:#fde8e8; color:#c0392b; }
.s-DONE        { background:#f3f3f3; color:#777; }

.row-acts { display:flex; gap:4px; opacity:0; transition:opacity .15s; }
.at tbody tr:hover .row-acts { opacity:1; }
.rbtn {
    padding:4px 9px; font-size:11px; border:1px solid #e0e0e0; background:#fff; color:#555;
    cursor:pointer; transition:all .12s; border-radius:2px; white-space:nowrap;
}
.rbtn:hover { border-color:var(--dark); color:var(--dark); }

.table-footer { padding:10px 20px; border-top:1px solid #f0f0ee; display:flex; align-items:center; justify-content:space-between; font-size:11px; color:#aaa; background:#fafaf8; }

.empty-table { text-align:center; padding:60px 20px; color:#bbb; }
.empty-table__icon { font-size:36px; margin-bottom:10px; }
{% endblock %}

{% block topbar_actions %}
<a href="{% url 'assignments:create' %}" class="btn btn--primary btn--sm">‚úèÔ∏è –ù–æ–≤–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ</a>
{% endblock %}

{% block content %}

{% with has_filters=f_q|add:f_status|add:f_dept|add:f_executor|add:f_controller|add:f_approver|add:f_atype|add:f_date_from|add:f_date_to %}
<form method="get" id="filter-form">

    <div class="toolbar">
        <!-- –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –ø–æ–∏—Å–∫ -->
        <div class="toolbar__top">
            <div>
                <span class="toolbar__title">–ü–æ—Ä—É—á–µ–Ω–∏—è</span>
                <span class="toolbar__count">{{ total }}</span>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <div class="search-wrap">
                    <span class="search-wrap__icon">üîç</span>
                    <input type="text" name="q" id="search-input" class="search-input"
                           placeholder="–ù–æ–º–µ—Ä, —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å‚Ä¶" value="{{ f_q }}">
                </div>
                {% if has_filters %}
                <a href="{% url 'assignments:list' %}" class="btn btn--ghost btn--sm">‚úï –°–±—Ä–æ—Å–∏—Ç—å</a>
                {% endif %}
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters-wrap">

            <!-- –°—Ç—Ä–æ–∫–∞ 1: —Å—Ç–∞—Ç—É—Å, —Ü–µ—Ö, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä, –≤–∏–∑–∞ -->
            <div class="filters-row">
                <div class="fg">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select name="status" class="f-select {% if f_status %}f-active{% endif %}">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        {% for val, label in status_choices %}
                        <option value="{{ val }}" {% if f_status == val %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="fg">
                    <label>–¶–µ—Ö / –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
                    <select name="dept" class="f-select {% if f_dept %}f-active{% endif %}">
                        <option value="">–í—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</option>
                        {% for d in departments %}
                        <option value="{{ d.id }}" {% if f_dept == d.id|stringformat:"s" %}selected{% endif %}>{{ d.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="fg">
                    <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                    <select name="executor" class="f-select {% if f_executor %}f-active{% endif %}">
                        <option value="">–í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</option>
                        {% for e in executors %}
                        <option value="{{ e.id }}" {% if f_executor == e.id|stringformat:"s" %}selected{% endif %}>
                            {{ e.last_name }} {{ e.first_name|slice:":1" }}.{{ e.middle_name|slice:":1" }}.
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="fg">
                    <label>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏–π</label>
                    <select name="controller" class="f-select {% if f_controller %}f-active{% endif %}">
                        <option value="">–í—Å–µ</option>
                        {% for e in controllers %}
                        <option value="{{ e.id }}" {% if f_controller == e.id|stringformat:"s" %}selected{% endif %}>
                            {{ e.last_name }} {{ e.first_name|slice:":1" }}.{{ e.middle_name|slice:":1" }}.
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="fg">
                    <label>–í–∏–∑–∏—Ä—É—é—â–∏–π</label>
                    <select name="approver" class="f-select {% if f_approver %}f-active{% endif %}">
                        <option value="">–í—Å–µ</option>
                        {% for e in approvers %}
                        <option value="{{ e.id }}" {% if f_approver == e.id|stringformat:"s" %}selected{% endif %}>
                            {{ e.last_name }} {{ e.first_name|slice:":1" }}.{{ e.middle_name|slice:":1" }}.
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="fg">
                    <label>–í–∏–¥ –ø–æ—Ä—É—á–µ–Ω–∏—è</label>
                    <select name="atype" class="f-select {% if f_atype %}f-active{% endif %}">
                        <option value="">–í—Å–µ –≤–∏–¥—ã</option>
                        {% for t in assignment_types %}
                        <option value="{{ t.id }}" {% if f_atype == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- –°—Ç—Ä–æ–∫–∞ 2: –¥–∞—Ç—ã + –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ -->
            <div class="filters-row" style="padding-bottom:12px;">
                <div class="fg">
                    <label>–°—Ä–æ–∫ —Å</label>
                    <input type="date" name="date_from" id="date_from"
                           class="f-date {% if f_date_from %}f-active{% endif %}"
                           value="{{ f_date_from }}">
                </div>

                <div class="fg">
                    <label>–°—Ä–æ–∫ –ø–æ</label>
                    <input type="date" name="date_to" id="date_to"
                           class="f-date {% if f_date_to %}f-active{% endif %}"
                           value="{{ f_date_to }}">
                </div>

                <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ -->
                <div class="fg">
                    <span class="qd-label">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞</span>
                    <div class="quick-dates">
                        <button type="button" class="qbtn" onclick="setDateTo(0)">–°–µ–≥–æ–¥–Ω—è</button>
                        <button type="button" class="qbtn" onclick="setDateTo(3)">+3 –¥–Ω—è</button>
                        <button type="button" class="qbtn" onclick="setDateTo(7)">+7 –¥–Ω–µ–π</button>
                        <button type="button" class="qbtn" onclick="setDateTo(14)">+2 –Ω–µ–¥–µ–ª–∏</button>
                        <button type="button" class="qbtn" onclick="setEndMonth()">–ö–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞</button>
                        <button type="button" class="qbtn" onclick="setEndNextMonth()">–°–ª–µ–¥. –º–µ—Å—è—Ü</button>
                        <button type="button" class="qbtn" onclick="clearDates()" style="color:#e53935;border-color:#fde8e8;">‚úï –î–∞—Ç—ã</button>
                    </div>
                </div>

                <div class="fg" style="justify-content:flex-end;">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn--primary btn--sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>

        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –±–µ–π–¥–∂–∏ -->
        {% if has_filters %}
        <div class="active-filters">
            <span class="af-label">–§–∏–ª—å—Ç—Ä—ã:</span>
            {% if f_status %}
            <span class="af-badge" onclick="clearFilter('status')">
                –°—Ç–∞—Ç—É—Å: {{ f_status }} √ó
            </span>
            {% endif %}
            {% if f_dept %}
            <span class="af-badge" onclick="clearFilter('dept')">
                –¶–µ—Ö: {{ f_dept }} √ó
            </span>
            {% endif %}
            {% if f_executor %}
            <span class="af-badge" onclick="clearFilter('executor')">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å √ó</span>
            {% endif %}
            {% if f_controller %}
            <span class="af-badge" onclick="clearFilter('controller')">–ö–æ–Ω—Ç—Ä–æ–ª—ë—Ä √ó</span>
            {% endif %}
            {% if f_approver %}
            <span class="af-badge" onclick="clearFilter('approver')">–í–∏–∑–∏—Ä—É—é—â–∏–π √ó</span>
            {% endif %}
            {% if f_atype %}
            <span class="af-badge" onclick="clearFilter('atype')">–í–∏–¥ √ó</span>
            {% endif %}
            {% if f_date_from or f_date_to %}
            <span class="af-badge" onclick="clearFilter('date_from');clearFilter('date_to')">
                –°—Ä–æ–∫: {% if f_date_from %}—Å {{ f_date_from }}{% endif %}{% if f_date_to %} –ø–æ {{ f_date_to }}{% endif %} √ó
            </span>
            {% endif %}
            {% if f_q %}
            <span class="af-badge" onclick="clearFilter('q')">¬´{{ f_q }}¬ª √ó</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="bulk-bar" id="bulk-bar">
            <div class="bulk-info">–í—ã–±—Ä–∞–Ω–æ: <span id="bulk-count">0</span></div>
            <div class="bulk-sep"></div>
            <button type="button" class="bbtn" onclick="bulkAction('status_progress')">‚ñ∂ –í —Ä–∞–±–æ—Ç–µ</button>
            <button type="button" class="bbtn" onclick="bulkAction('status_done')">‚úì –ò—Å–ø–æ–ª–Ω–µ–Ω–æ</button>
            <div class="bulk-sep"></div>
            <button type="button" class="bbtn" onclick="bulkAction('notify_new')">üì® –£–≤–µ–¥–æ–º–∏—Ç—å</button>
            <button type="button" class="bbtn" onclick="bulkAction('notify_remind')">üîî –ù–∞–ø–æ–º–Ω–∏—Ç—å</button>
            <button type="button" class="bbtn" onclick="bulkAction('notify_deadline')">üìÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ä–æ–∫–æ–≤</button>
            <div class="bulk-sep"></div>
            <button type="button" class="bbtn" onclick="bulkAction('print')">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            <button type="button" class="bbtn--x" onclick="deselectAll()">‚úï</button>
        </div>
    </div>

</form>

<!-- –¢–ê–ë–õ–ò–¶–ê -->
<div class="table-wrap">
{% if assignments %}
<table class="at" id="at">
    <thead>
        <tr>
            <th class="col-cb"><input type="checkbox" id="check-all"></th>
            <th class="s" onclick="sortBy('document_number')">
                –î–æ–∫—É–º–µ–Ω—Ç <span class="sort-ic {% if current_sort == 'document_number' %}up{% elif current_sort == '-document_number' %}dn{% endif %}">
                    {% if current_sort == 'document_number' %}‚ñ≤{% elif current_sort == '-document_number' %}‚ñº{% else %}‚áÖ{% endif %}
                </span>
            </th>
            <th>–¢–µ–∫—Å—Ç –ø–æ—Ä—É—á–µ–Ω–∏—è</th>
            <th class="s" onclick="sortBy('executor')">
                –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å <span class="sort-ic {% if current_sort == 'executor' %}up{% elif current_sort == '-executor' %}dn{% endif %}">
                    {% if current_sort == 'executor' %}‚ñ≤{% elif current_sort == '-executor' %}‚ñº{% else %}‚áÖ{% endif %}
                </span>
            </th>
            <th class="s" onclick="sortBy('deadline')">
                –°—Ä–æ–∫ <span class="sort-ic {% if current_sort == 'deadline' %}up{% elif current_sort == '-deadline' %}dn{% endif %}">
                    {% if current_sort == 'deadline' %}‚ñ≤{% elif current_sort == '-deadline' %}‚ñº{% else %}‚áÖ{% endif %}
                </span>
            </th>
            <th>–ö–æ–Ω—Ç—Ä–æ–ª—ë—Ä</th>
            <th>–í–∏–∑–∏—Ä—É—é—â–∏–π</th>
            <th class="s" onclick="sortBy('status')">
                –°—Ç–∞—Ç—É—Å <span class="sort-ic">{% if current_sort == 'status' %}‚ñ≤{% elif current_sort == '-status' %}‚ñº{% else %}‚áÖ{% endif %}</span>
            </th>
            <th style="width:80px;"></th>
        </tr>
    </thead>
    <tbody>
        {% for task in assignments %}
        <tr data-id="{{ task.id }}">
            <td class="col-cb"><input type="checkbox" class="row-check" value="{{ task.id }}"></td>

            <td>
                <div class="doc-type">{{ task.assignment_type.name }}</div>
                <a href="{% url 'assignments:detail' task.id %}" class="doc-num" style="text-decoration:none;color:inherit;">‚Ññ {{ task.document_number }}</a>
                <div class="doc-date">{{ task.issue_date|date:"d.m.Y" }}</div>
            </td>

            <td class="cell-desc">
                <div class="desc-txt">{{ task.description }}</div>
            </td>

            <td>
                <div class="pname">
                    {{ task.executor.last_name }} {{ task.executor.first_name|slice:":1" }}.{{ task.executor.middle_name|slice:":1" }}.
                </div>
                <div class="pdept">{{ task.executor.department.name|default:"‚Äî" }}</div>
            </td>

            <td>
                <div class="dl-date">{{ task.deadline|date:"d.m.Y" }}</div>
                <div class="dl-badge {% if task.status == 'OVERDUE' or task.deadline < today %}db-ov{% elif task.deadline == today %}db-td{% elif task.deadline <= today %}db-sn{% else %}db-ok{% endif %}"
                     data-deadline="{{ task.deadline|date:'Y-m-d' }}"></div>
            </td>

            <td>
                {% if task.controller %}
                <div class="pname" style="font-size:11px;">
                    {{ task.controller.last_name }} {{ task.controller.first_name|slice:":1" }}.{{ task.controller.middle_name|slice:":1" }}.
                </div>
                {% else %}<span style="color:#ddd;">‚Äî</span>{% endif %}
            </td>

            <td>
                {% if task.approver %}
                <div class="pname" style="font-size:11px;">
                    {{ task.approver.last_name }} {{ task.approver.first_name|slice:":1" }}.{{ task.approver.middle_name|slice:":1" }}.
                </div>
                {% else %}<span style="color:#ddd;">‚Äî</span>{% endif %}
            </td>

            <td>
                <span class="sbadge s-{{ task.status }}">{{ task.get_status_display }}</span>
            </td>

            <td>
                <div class="row-acts">
                    <button class="rbtn" onclick="editTask({{ task.id }})">‚úèÔ∏è</button>
                    <button class="rbtn" onclick="printTask({{ task.id }})">üñ®Ô∏è</button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="table-footer">
    <span>–ü–æ–∫–∞–∑–∞–Ω–æ: <b>{{ total }}</b></span>
    {% if f_date_to %}<span>–°—Ä–æ–∫ –ø–æ: <b>{{ f_date_to }}</b></span>{% endif %}
</div>

{% else %}
<div class="empty-table">
    <div class="empty-table__icon">üì≠</div>
    <div style="font-size:14px;color:#888;margin-bottom:4px;">–ü–æ—Ä—É—á–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
    <div style="font-size:12px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞</div>
</div>
{% endif %}
</div>

<!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
<form method="post" action="{% url 'assignments:bulk' %}" id="bulk-form">
    {% csrf_token %}
    <input type="hidden" name="action" id="bulk-action">
    <input type="hidden" name="next" value="{{ request.get_full_path }}">
    <div id="bulk-ids"></div>
</form>

{% endwith %}
{% endblock %}


{% block extra_js %}
<script>
// ‚îÄ‚îÄ –ü–æ–¥–ø–∏—Å–∏ –¥–Ω–µ–π —É –¥–µ–¥–ª–∞–π–Ω–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const today = new Date(); today.setHours(0,0,0,0);
document.querySelectorAll('.dl-badge[data-deadline]').forEach(el => {
    const d = new Date(el.dataset.deadline); d.setHours(0,0,0,0);
    const diff = Math.round((d - today) / 86400000);
    if (el.classList.contains('db-ov')) {
        el.textContent = diff < 0 ? `–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${Math.abs(diff)} –¥–Ω.` : '–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
    } else if (diff === 0) {
        el.textContent = '—Å–µ–≥–æ–¥–Ω—è';
    } else if (diff === 1) {
        el.textContent = '–∑–∞–≤—Ç—Ä–∞';
    } else {
        el.textContent = `${diff} –¥–Ω.`;
    }
});

// ‚îÄ‚îÄ –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–∞—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isoDate(d) { return d.toISOString().split('T')[0]; }

function setDateTo(days) {
    const d = new Date(); d.setDate(d.getDate() + days);
    document.getElementById('date_to').value = isoDate(d);
    document.getElementById('date_to').classList.add('f-active');
    // –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('.qbtn').forEach(b => b.classList.remove('qbtn--active'));
    event.target.classList.add('qbtn--active');
}
function setEndMonth() {
    const d = new Date();
    const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
    document.getElementById('date_to').value = isoDate(end);
    document.getElementById('date_to').classList.add('f-active');
    document.querySelectorAll('.qbtn').forEach(b => b.classList.remove('qbtn--active'));
    event.target.classList.add('qbtn--active');
}
function setEndNextMonth() {
    const d = new Date();
    const end = new Date(d.getFullYear(), d.getMonth() + 2, 0);
    document.getElementById('date_to').value = isoDate(end);
    document.getElementById('date_to').classList.add('f-active');
    document.querySelectorAll('.qbtn').forEach(b => b.classList.remove('qbtn--active'));
    event.target.classList.add('qbtn--active');
}
function clearDates() {
    document.getElementById('date_from').value = '';
    document.getElementById('date_to').value = '';
    document.getElementById('date_from').classList.remove('f-active');
    document.getElementById('date_to').classList.remove('f-active');
    document.querySelectorAll('.qbtn').forEach(b => b.classList.remove('qbtn--active'));
}

// –ê–≤—Ç–æ-—Å–∞–±–º–∏—Ç –ø–æ—Å–ª–µ –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫
document.querySelectorAll('.qbtn:not([onclick*="clearDates"])').forEach(btn => {
    btn.addEventListener('click', () => {
        setTimeout(() => document.getElementById('filter-form').submit(), 50);
    });
});

// ‚îÄ‚îÄ –°–±—Ä–æ—Å –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clearFilter(name) {
    const params = new URLSearchParams(window.location.search);
    params.delete(name);
    window.location.search = params.toString();
}

// ‚îÄ‚îÄ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sortBy(col) {
    const params = new URLSearchParams(window.location.search);
    const cur = params.get('sort') || '';
    params.set('sort', cur === col ? '-' + col : col);
    window.location.search = params.toString();
}

// ‚îÄ‚îÄ –ß–µ–∫–±–æ–∫—Å—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const checkAll  = document.getElementById('check-all');
const bulkBar   = document.getElementById('bulk-bar');
const bulkCount = document.getElementById('bulk-count');

function getChecked() {
    return [...document.querySelectorAll('.row-check:checked')].map(c => c.value);
}
function updateBulk() {
    const ids = getChecked();
    bulkBar.classList.toggle('visible', ids.length > 0);
    bulkCount.textContent = ids.length;
    document.querySelectorAll('.row-check').forEach(cb => {
        cb.closest('tr').classList.toggle('sel', cb.checked);
    });
}

if (checkAll) {
    checkAll.addEventListener('change', () => {
        document.querySelectorAll('.row-check').forEach(cb => cb.checked = checkAll.checked);
        updateBulk();
    });
}
document.querySelectorAll('.row-check').forEach(cb => {
    cb.addEventListener('change', () => {
        const all = [...document.querySelectorAll('.row-check')];
        checkAll.indeterminate = all.some(c=>c.checked) && !all.every(c=>c.checked);
        checkAll.checked = all.every(c=>c.checked);
        updateBulk();
    });
});
function deselectAll() {
    document.querySelectorAll('.row-check').forEach(cb => cb.checked = false);
    checkAll.checked = false; checkAll.indeterminate = false;
    updateBulk();
}

// ‚îÄ‚îÄ –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bulkAction(action) {
    const ids = getChecked();
    if (!ids.length) return;
    document.getElementById('bulk-action').value = action;
    const c = document.getElementById('bulk-ids');
    c.innerHTML = ids.map(id => `<input type="hidden" name="ids" value="${id}">`).join('');
    document.getElementById('bulk-form').submit();
}

// ‚îÄ‚îÄ –î–µ–π—Å—Ç–≤–∏—è –≤ —Å—Ç—Ä–æ–∫–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function editTask(id)  { window.location.href = `/assignments/${id}/edit/`; }
function printTask(id) { window.open(`/reports/print-selected/?ids=${id}`, '_blank'); }

// ‚îÄ‚îÄ –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let searchTimer;
document.getElementById('search-input')?.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => document.getElementById('filter-form').submit(), 500);
});
</script>
{% endblock %}
